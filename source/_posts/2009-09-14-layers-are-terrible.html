---
layout: post
title: "Layers are terrible"
date: 2009-09-14
comments: false
---

<div class='post'>
When I talk about testing frameworks, I often mention Zope layers and say they are terrible. Some people have asked me for details on their terror and for justification of my opinion.<br /><br />Here's all I've got. It's based on my experiences using layers with Zope 3.2 in Launchpad.<br /><br /><b>1. Layers have unnecessary magic</b><br /><br />A layer can subclass another layer, which is fine. Subclassing means that your new, derived layer rests on top of the old, base layer.<br /><br />When you define a derived layer though, you don't call the base layer's methods yourself, like you would for any other Python subclass. Why not? Because zope.testing magically up-calls the base layer's methods for you.<br /><br />Yuck.<br /><br />The upshot is that you write non-standard Python that confuses people not familiar with zope.testing. Also, you have no way of <span style="font-style: italic;">not</span> calling the base methods, which is unfairly restrictive.<br /><br /><b>2. Layers are combined through inheritance</b><br /><br />Each unit test is in a single layer. If you want a unit test to have the set up and tear down provided by layer A <i>and</i> the set up and tear down of layer B, you have to define a wholly new layer C that subclasses both A and B.<br /><br />The layer C doesn't really mean anything other than "A and B". It doesn't really deserve a name, but it has to have one, since it has to be a new class.<br /><br />Since layers are often used to share expensive resources between tests, you end up with a binary explosion of layer subclasses, as you move toward needing one for every subset of available resources.<br /><br />This adds code and thus maintenance work, and is actually less clear than simply declaring that a test uses layers A and B.<br /><br /><b>3. Layers are implemented badly</b><br /><br />Layers are all about changing the way a test is run. They supplement the run with extra work to establish a known base state for the test.<br /><br />If you think about it, the stuff that's required to run a test is a property of the test.<br /><br />Python's <code>unittest</code> module recognizes this. One of the few public methods of a <code>TestCase</code> object is its <code>run()</code> method. <code>run()</code> is also a method of <code>TestSuite</code>. This means that if you want to customize the way a test or a group of tests is run, you should override / re-implement the <code>run()</code> method.<br /><br />Layers don't do this. Instead they change the way tests are gathered, the way they are reported <i>and</i> the way they are run. This means tests that rely on layers can only be run with the Zope test runner, and not with nose or trial or what have you.<br /><br /><b>4. Layers solve too many problems</b><br /><br />Layers are not simply a way of sharing expensive resources between tests, they are also a way of using resources that cannot be torn down.<br /><br />The implementation does this by detecting that a layer cannot be torn down, then spawning a new process to run the rest of the tests in.<br /><br />It kind of sucks to have things that cannot be torn down in process, and it definitely sucks to conflate resource sharing with odd subprocess management.<br /><br /><b>5. Layers are not Zopish</b><br /><br />As far as I can tell, one of the themes of Zope 3 is small, interchangeable pieces loosely joined together.<br /><br />Layers seem to be something that could have been done much better using the Zope component architecture. Perhaps they could give <code>getUtility</code> some practical purpose in life.<br /><br /><b>What then?</b><br /><br />As much as I hate to say so, I don't think there's much hope for layers as a concept. One is probably better served by replacing one's existing layers with <a href="https://launchpad.net/testresources">testresources</a>. It looks like it takes <a href="https://bugs.edge.launchpad.net/launchpad-foundations/+bug/419691/comments/2">quite a lot of work to do so</a>.<br /><br />That's it. Five reasons and a lot of paragraphs. Please let me know if I've made mistakes, or if newer versions of zope.testing are better. Also, please gently correct me if I've left the path of <a href="http://jcalderone.livejournal.com/47657.html">civility and common courtesy</a>.</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>ChrisW<span class='comment-date'> on 2010-01-11 09:58</span></div>
<div class='content'>
The punted alternative right now is:<br /><br />http://pypi.python.org/pypi/testresources<br /><br />...which sadly seems to be lacking on the docs and examples front.</div>
</div>
<div class='comment'>
<div class='author'>jcalderone<span class='comment-date'> on 2009-09-14 23:52</span></div>
<div class='content'>
Hi jml,<br /><br />I&#39;ve never used Layers, but these points seem right.  One thing that I find missing from this post is a discussion of some of the alternatives.  For example, I know I am sometimes tempted to add new methods to TestCase and require the runner to find them.  It&#39;s not always obvious how to add features without expanding the interface.  When I started writing this post, I had an example of this, but then it slipped away from me.  Oops.</div>
</div>
</div>
