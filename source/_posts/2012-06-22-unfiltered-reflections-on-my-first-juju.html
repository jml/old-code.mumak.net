---
layout: post
title: "Unfiltered reflections on my first Juju charm"
date: 2012-06-22
comments: false
---

<div class='post'>
<br /><br /><div>I just finished up my first <a href="https://juju.ubuntu.com/">Juju</a> charm, designed to deploy the tiny and not-yet-useful <a href="https://launchpad.net/libdep-service/">libdep-service</a>, which is going to become a micro-service used by <a href="https://launchpad.net/pkgme-service">pkgme-service</a>, which exists to automatically package submissions by application developers to <a href="http://developer.ubuntu.com/">developer.ubuntu.com</a>.</div><div><br /></div><div>The charm works, insofar as it brings up a Django service that implements the API. It's not really ready for others to use, as it doesn't provide any interfaces and doesn't make good use of Juju's configuration system. </div><div><br /></div><div>It's very early days for me as a Juju user. The notes below are largely about problems, but I'm actually fairly optimistic that having a charm for my service will be very useful. Two big benefits so far:</div><div><ol><li>There's less code than in my equivalent fabric task for deploying to EC2</li><li>I can deploy to LXC on my laptop, which means a fast, clean, local, production-like environment</li></ol><div>Anyway, on with the notes.</div></div><ul><li><span style="background-color: white;">#juju is heaps better when America is awake</span></li><li><span style="background-color: white;">upgrading with apt requires a lot of options, but this is quite a standard</span><span style="background-color: white;">&nbsp;action</span></li><ul><li><span style="background-color: white;">e.g. <span style="font-family: 'Courier New', Courier, monospace;">sudo DEBIAN_FRONTEND=noninteractive apt-get dist-upgrade -q -y</span></span></li><li>You get this by default if you don't use sudo, and you don't have to use sudo</li></ul><li><span style="background-color: white;">so many <a href="https://bugs.launchpad.net/juju/+bug/955209">things that are just warnings are marked as<span style="font-family: 'Courier New', Courier, monospace;"> ERROR</span></a>, makes debugging&nbsp;</span><span style="background-color: white;">much harder</span></li><li><span style="background-color: white;">perhaps this is intrinsic, but there are almost always four to six errors&nbsp;</span><span style="background-color: white;">to be debugged at once</span></li><li><span style="background-color: white;">Don't use lp: URLs to fetch branches because it generates warnings. Use http://code.launchpad.net/ instead.</span></li><li><span style="background-color: white;">Is there a way to have a local apt mirror or something to make iterating</span><span style="background-color: white;">&nbsp;faster? &nbsp;Is this what I've got already?</span></li><li><span style="background-color: white;">When translating from fabric <span style="font-family: 'Courier New', Courier, monospace;">run("cd X &amp;&amp; Y")</span>, remember that fabric&nbsp;</span><span style="background-color: white;">restores directory after <span style="font-family: 'Courier New', Courier, monospace;">run</span></span></li><ul><li><span style="background-color: white;"><span style="font-family: inherit;">Use </span><span style="font-family: 'Courier New', Courier, monospace;">(cd X &amp;&amp; Y)</span><span style="font-family: inherit;">&nbsp;in bash instead, runs in a subshell</span></span></li></ul><li><span style="background-color: white;"><b>ACTION:</b> Look up 'man 8 apt-get' for --force-yes and why it's bad</span></li><li><span style="background-color: white;">Long-ish iteration cycle (2-5 mins) makes it a bit slow going</span></li><ul><li><span style="background-color: white;">See also&nbsp;<a href="https://bugs.launchpad.net/juju/+bug/1015644">Users not told when deploy actually completes</a></span></li><li><span style="background-color: white;">Iterating with 'deploy --upgrade', watch 'debug-log', 'destroy-service',&nbsp;</span><span style="background-color: white;">(sometimes 'bzr ci'; 'bzr push')</span></li></ul><ul><li><span style="background-color: white;"><b>ACTION:</b> Poke around more with 'juju debug-log' (see also&nbsp;</span><a href="https://bugs.launchpad.net/juju/+bug/1016003">"juju debug-hooks -h" doesn't say what 'debug-hooks' does</a>)</li></ul><li><span style="background-color: white;">After delegating to puppet, if that fails, the&nbsp;<span style="font-family: 'Courier New', Courier, monospace;">install</span>&nbsp;hook doesn't fail</span></li><li><span style="background-color: white;"><span style="background-color: white;">Ended up putting the puppet stuff should be in the charm to avoid having to commit &amp;</span><span style="background-color: white;">&nbsp;push the branch up</span></span></li><li><span style="background-color: white;">A little bit surprised that hooks run as root. &nbsp;I don't have a credible&nbsp;</span><span style="background-color: white;">alternative to hand, but I thought that this was what we wanted to get away</span><span style="background-color: white;">&nbsp;from with .debs.</span></li><ul><li><span style="background-color: white;">How do I run things with less privilege</span></li></ul><li><span style="background-color: white;">I do server-side changes a fair bit to fix things. It's easy to forget a&nbsp;</span><span style="background-color: white;">step when applying them back to the charm / manifest. No easy way of</span><span style="background-color: white;">&nbsp;checking either.</span></li><li><span style="background-color: white;">Bouncing on this command is heaps better:</span><span style="background-color: white;"><span style="font-family: 'Courier New', Courier, monospace;">juju deploy --repository=charms --upgrade \</span></span><span style="background-color: white; font-family: 'Courier New', Courier, monospace;">&nbsp; local:libdep-service &amp;&amp; jitsu watch libdep-service \<br />&nbsp; &nbsp; --state=started --num-units=1</span></li></ul><br /><br /></div>
