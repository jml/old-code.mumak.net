---
layout: post
title: "How to feel better (or, some tips on refactoring)"
date: 2011-11-04
comments: false
---

<div class='post'>
<span style="background-color: transparent;">A few months back I gave a lightning talk at the <a href="https://launchpad.net/">Launchpad</a> Thunderdome about how I do refactoring. &nbsp;It's very opinionated, and mostly applies to big, old code bases, but worth writing up anyway.</span><br /><span style="background-color: transparent;"><br /></span><br /><span style="background-color: transparent;">The core idea here is that very few things make me feel as good as deleting code. I love cleaning up code and the clean code base that results, and I'm sure that many others feel like me. As such, this is a guide on how to feel better.</span><br /><br /><b>1. Know your enemy</b><br /><br />“Functionality is an asset, code is a liability”. Truer words were never spoken. Every line of code is a potential source of bugs and a barrier to understanding, and thus carries a maintenance cost.<br /><br />Maintain an awareness of things that need refactoring. Here's a quick and incomplete list:<br /><br /><ul><li><span style="background-color: transparent;">unused code – this can be deleted</span></li><li><span style="background-color: transparent;">boilerplate – this should become a function or class</span></li><li><span style="background-color: transparent;">wrong documentation – these should be updated</span></li><li><span style="background-color: transparent;">two ways of doing something – perhaps there should be one</span></li><li><span style="background-color: transparent;">bad names – change them to something that makes you think less</span></li></ul><b>2. Keep a "yak stack"</b><br /><br /><a href="http://projects.csail.mit.edu/gsb/old-archive/gsb-archive/gsb2000-02-11.html" style="background-color: transparent;">Yak shaving</a><span style="background-color: transparent;">&nbsp;is "any seemingly pointless activity which is actually necessary to solve a problem which solves a problem which, several levels of recursion later, solves the real problem you're working on." (<a href="http://catb.org/jargon/html/Y/yak-shaving.html">Jargon File</a>)</span><br /><br />A few of us have extended the concept beyond the "actually necessary" to include anything that's making the task at hand more difficult and less fun but is not worth fixing <i>right</i>&nbsp;now. Hence the yak stack. Here's how it works:<br /><br />Whenever you come across something in your code base that is difficult to understand or that slows you down: make a note of it. When you've finished the task at hand, fix the problem. If you encounter other things that slow you down, write them down. Work through the list.<br /><br /><b>3. Every option is wrong</b><br /><br />In a big, old code base, there are probably many, many areas that need refactoring. &nbsp;Don't worry about which is the "best" place to start – there is no best place.<br /><br /><b>4. Start from green, stay green</b><br /><br />Never, ever refactor while your tests are failing. Refactoring is about changing the shape of code while preserving its behaviour. It's much harder to be sure you're keeping the behaviour if you are comparing one set of thirty tracebacks with another set of thirty tracebacks. Better to compare a passing ("green") test run with another passing test run.<br /><br />Run tests frequently. More often then you think you should. Commit often – think of it like quick save in a tough level of a video game. It frees you up to experiment more and means you have less in your head at any one time.<br /><br /><b>5. Do not nest</b><br /><br />Don't begin a refactoring while you are in the middle of another refactoring. If you find you must, use tools like '<a href="http://doc.bazaar.canonical.com/beta/en/user-guide/shelving_changes.html">bzr shelve</a>' to store your current diff and then work from the clean head of your branch.<br /><br /><b>6. Keep moving, leave a trail</b><br /><br />Don't get bogged down in details, otherwise you'll never finish. Literally. Someone will come along and distract you and before you know it, three months will pass and your refactoring branch will be full of conflicts. If you see something you are unsure of, mark it with a XXX or a FIXME or a TODO or whatever works for you and then continue with what you are doing.<br /><br />Tools like '<a href="http://launchpad.net/difftodo">bzr todo</a>' can make it really easy to check to see if you've added any XXX comments.<br /><br /><b>7. Translate tests with care</b><br /><br />As said above, refactoring is about changing the shape of code while preserving its behaviour. When you update tests, you risk changing your definition of the system's behaviour – so be careful.<br /><br /><b>8. Confront uncertainty with destruction</b><br /><br />If you see some code and you are not sure if it's needed, delete it. Doesn't matter if it's a whole function or just an odd line. If you have a test suite, and it was important, that will catch the failure. If you have version control, and it was important, one of your collaborators will notice and revert the change.<br /><br />If it was important and neither of these happened, then your whole project has learned something new about itself, and that's probably worth the hassle. (Oh, add tests &amp; better docs after this happens.)<br /><br /><b>9. Good grep tools</b><br /><br />Remember that symbols aren't only referenced from files that match *.py. &nbsp;In big code bases there are often other sorts of files that refer to symbols in the main code. In Launchpad, for example, we have ZCML and doctest files that refer to symbols. When you want to know how something is used or you want to rename something, make sure you use a grep command that actually finds everything.<br /><br />Ideally, you should be able to run this command faster than you can think about wanting to do it.<br /><br />Personally, I use 'bzr grep' a lot. Others recommend 'ack'.<br /><br /><b>10. There will be failures</b><br /><br />Mentally prepare yourself for the fact that the first two or three full test runs after your refactoring will fail. &nbsp;This is especially important for code bases that have multi-hour test run times.<br /><br />If you think this way, then you won't be as discouraged when it actually happens.<br /><br /><b style="background-color: transparent;">11. Finish the job</b><br /><br />Busy people refactoring a big code base are often tempted to apply a refactoring to only a single part. &nbsp;For example, some useful function is extracted from repeated boilerplate in a few other functions. However, many, many other instances in the code base continue to use the repeated boilerplate.<br /><br />This is <i>almost</i> worse than just leaving the repeated boilerplate. &nbsp;There are now two idiomatic ways of doing the activity. &nbsp;Further, other developers who work on other parts of the code base probably won't find out about it, and might end up repeating your refactoring. Ugh. How is anyone new expected to get to grips with this code?<br /><br />Similarly, if a class, function or concept is renamed, rename it everywhere, especially in the documentation.<br /><br />It's difficult and often tedious, but it really is worth taking refactorings to completion. Apply them to the whole code base, or not at all.<br /><br />Note that I'm referring to completeness, not perfection. If you block on perfection, you never get anything useful done. If you aim for frequent incremental improvements, you soar.<br /><br /><b>12. Read these books</b><br /><br />I highly recommend "<a href="http://www.amazon.com/Refactoring-Improving-Design-Existing-Code/dp/0201485672/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1320430812&amp;sr=1-1">Refactoring</a>" by Martin Fowler and "<a href="http://www.amazon.com/Refactoring-Improving-Design-Existing-Code/dp/0201485672/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1320430812&amp;sr=1-1">TDD by Example</a>" by Kent Beck. I stole many of these ideas from them.<br /><div><br /></div><div><br /></div><div><b>Over to you</b></div><div><b><br /></b></div><div>This was very much just a dump of how I do refactoring when hacking on Launchpad. I'm always keen to learn more, and would love to hear about what works for you.</div><div><br /></div></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Michael Hudson-Doyle<span class='comment-date'> on 2011-11-05 05:27</span></div>
<div class='content'>
There&#39;s that Java thing that randomly mutates your code and complains if no test breaks which sounds sort of vaguely like that, but it&#39;s not quite the same I guess.</div>
</div>
<div class='comment'>
<div class='author'>jml<span class='comment-date'> on 2011-11-04 18:54</span></div>
<div class='content'>
I think that&#39;s exactly right.</div>
</div>
<div class='comment'>
<div class='author'>glyph<span class='comment-date'> on 2011-11-04 18:51</span></div>
<div class='content'>
As to point 7, I&#39;d say that &quot;with care&quot; is not quite good enough.  Change the test, run it, it should pass; but then always go change the implementation in a way which should break the test, and make sure it still fails.<br /><br />If we had really good coverage tools which were constantly informing us in a useful way of which lines were being run, with good IDE integration, this step might not be necessary, but even the snazzier IDEs I&#39;ve seen do not seem to have this down.</div>
</div>
</div>
